library(ggplot2)
library(cmdstanr)

# Data ----
data <- data.frame(time = c(361.650,
                            371.342,
                            385.375,
                            385.375 + 0.21,
                            385.375 + 0.21*2,
                            395.441,
                            397.402,
                            398.435,
                            400.562,
                            404.235,
                            406.975,
                            409.421,
                            411.735,
                            412.428,
                            413.196,
                            413.237,
                            413.390,
                            414.279,
                            414.301,
                            418.174,
                            418.809,
                            418.911,
                            419.644,
                            419.800,
                            419.866,
                            420.171,
                            423.259,
                            427.507,
                            427.719,
                            428.112,
                            428.640,
                            430.387,
                            430.434,
                            431.014,
                            431.629,
                            432.983,
                            433.012,
                            435.160,
                            437.390,
                            438.094,
                            438.308,
                            438.385,
                            438.855,
                            438.942,
                            439.375,
                            440.000,
                            440.050,
                            440.782,
                            441.571,
                            442.395,
                            443.018,
                            443.200,
                            443.806,
                            444.254,
                            445.042,
                            445.617,
                            447.628,
                            447.979,
                            448.226,
                            449.269,
                            450.722,
                            452.540,
                            453.445,
                            453.675,
                            454.006,
                            454.746,
                            456.382,
                            457.181,
                            457.373,
                            458.927,
                            459.787,
                            459.834,
                            460.151,
                            461.083,
                            461.832,
                            462.100,
                            462.764,
                            462.869,
                            463.381,
                            463.529,
                            464.317,
                            464.336,
                            464.418,
                            465.002,
                            465.760,
                            465.916,
                            467.295,
                            467.506,
                            467.670,
                            468.035,
                            468.468,
                            468.531,
                            469.287,
                            469.525,
                            473.330,
                            473.698,
                            473.737,
                            474.033,
                            474.814,
                            475.057,
                            475.604,
                            476.531,
                            476.615,
                            477.918,
                            478.023,
                            478.681,
                            478.800,
                            478.831,
                            479.375,
                            479.896,
                            480.900,
                            481.110,
                            481.666,
                            481.891,
                            482.295,
                            482.400,
                            483.702,
                            485.982,
                            486.277,
                            487.742,
                            488.134,
                            488.312,
                            488.943,
                            489.049,
                            489.294,
                            489.899,
                            490.057,
                            490.494,
                            491.749,
                            492.099,
                            492.213,
                            492.660,
                            492.913,
                            493.011,
                            493.560,
                            493.722,
                            493.934,
                            494.344,
                            494.625,
                            494.829,
                            494.922,
                            495.744,
                            496.184,
                            496.485,
                            497.491,
                            497.970,
                            498.200,
                            498.458,
                            499.603,
                            499.751,
                            499.915,
                            500.573,
                            501.949,
                            503.281,
                            503.952,
                            504.062,
                            504.461,
                            504.805,
                            504.875,
                            505.191,
                            505.409,
                            505.680,
                            506.487,
                            507.009,
                            507.290,
                            507.807,
                            508.134,
                            508.270,
                            508.322,
                            508.835,
                            509.209,
                            509.275,
                            510.033,
                            510.404,
                            510.534,
                            510.944,
                            511.158,
                            512.385,
                            513.858,
                            514.152,
                            514.259,
                            514.360,
                            515.504,
                            516.067,
                            516.234,
                            516.571,
                            516.598,
                            516.770,
                            518.043,
                            518.351,
                            518.679,
                            518.716,
                            519.518,
                            519.588,
                            520.212,
                            520.479,
                            521.280,
                            521.563,
                            521.654,
                            521.740,
                            522.074,
                            523.788,
                            524.262,
                            524.476,
                            525.481,
                            525.746,
                            525.913,
                            525.970,
                            525.970 + 0.0295,
                            525.970 + 2*0.0295,
                            526.146,
                            526.714,
                            527.014,
                            527.239,
                            527.265,
                            527.402,
                            527.853,
                            528.080,
                            528.494,
                            529.433,
                            530.213,
                            530.731,
                            530.762,
                            534.323,
                            535.525,
                            536.020,
                            536.072,
                            537.320,
                            537.816,
                            539.109,
                            540.481,
                            540.903,
                            541.272,
                            541.817,
                            542.220,
                            543.748,
                            544.216,
                            544.666,
                            545.057,
                            546.015,
                            547.001,
                            547.126,
                            547.486,
                            547.679,
                            550.969,
                            551.756,
                            551.938,
                            552.937,
                            553.100,
                            555.424,
                            555.520,
                            556.051,
                            556.666,
                            556.733,
                            556.960,
                            558.281,
                            559.575,
                            560.835,
                            565.296,
                            567.185,
                            568.247,
                            570.980,
                            573.636,
                            573.695,
                            573.977,
                            574.817,
                            574.833,
                            575.320,
                            575.395,
                            578.149,
                            580.031,
                            580.168,
                            580.550,
                            581.610,
                            582.548,
                            583.042,
                            583.610,
                            585.556,
                            587.528,
                            589.231,
                            590.363,
                            591.516,
                            593.305,
                            593.621,
                            597.139,
                            599.765,
                            600.811,
                            602.938,
                            603.783,
                            608.212,
                            609.449,
                            610.069,
                            613.509,
                            614.573,
                            614.753,
                            615.804)
)
data$time <- (data$time - 18.40) / 4
data$cumulative <- cumsum(rep(1,nrow(data)))

# Plot data ----
ggplot(data, aes(x = time, y = cumulative)) +
  geom_point(size = 1) +
  xlab("Time(seconds)") +
  ylab("Cumulative Count") +
  ggtitle("The Number of Popcorn Kernels Popped over Time") +
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid = element_blank(), axis.line = element_line(colour = "black"))


# Fit model ----
model <- cmdstan_model("/Users/todd/Code/learning-is-fun/kernel_popping/binomial_model.stan")

fit <- model$sample(data = list(Nobs = nrow(data),
                                time = data$time),
                    chains = 4, iter_warmup = 1000, iter_sampling = 1000)

draws <- fit$draws(format = "df")


# Plot model + data ----
exc <- diff(range(data$time)) / sqrt(diff(range(data$time)))
bounds <- c(min(data$time) - exc, max(data$time) + exc)

time_range <- seq(bounds[1], bounds[2], length = 2000)

# Posterior mean estimate
pme_prob <- function(t) {
  prob <- pgamma(q = t,
                 shape = mean(draws$shape),
                 rate = mean(draws$rate))

  prob * nrow(data)
}

# Posterior predictive distribution
# Probability [draws x time_point]
ppd_prob <- apply(draws[,-1], 1, function(draw) {
  prob <- pgamma(q = time_range,
                 shape = draw["shape"],
                 rate = draw["rate"])

  prob
})

# Cumulative count [sampled value x time_point]
ppd_count <- apply(ppd_prob, 1, function(draws) { rbinom(2e4, nrow(data), draws) })


# Posterior compatability intervals
CI_prob <- apply(ppd_prob, 1, function(draws) { quantile(draws, c(0.05, 0.95)) * nrow(data) })
CI_count <- apply(ppd_count, 2, function(samples) { quantile(samples, c(0.05, 0.95))})

ggplot(data, aes(x = time, y = cumulative)) +
  xlab("Time(seconds)") +
  ylab("Cumulative Count") +
  ggtitle("The Number of Popcorn Kernels Popped over Time") +
  # 90% compatability interval for cumulative counts
  geom_ribbon(data = data.frame(t = time_range),
              aes(x = t,
                  ymin = CI_count[1,],
                  ymax = CI_count[2,],
                  fill = "Predicted # of Popped Kernels"),
              alpha = 0.25,
              inherit.aes = F) +
  # 90% Compatability Interval for the probability parameter
  geom_ribbon(data = data.frame(t = time_range),
              aes(x = t,
                  ymin = CI_prob[1,],
                  ymax = CI_prob[2,],
                  fill = "Expected # of Popped Kernels"),
              alpha = 0.25,
              inherit.aes = F) +
  geom_point(size = 1.3, alpha = 0.7) +
  # Posterior Mean Estimate
  stat_function(fun = pme_prob,
                aes(color = "Expected # of Popped Kernels"),
                alpha = 0.9,
                linewidth = 1.2) +
  scale_fill_manual(name = "90% Compatability Intervals",
                    values = c("Predicted # of Popped Kernels" = "black",
                               "Expected # of Popped Kernels" = "darkred")) +
  scale_color_manual(name = "Posterior Mean Estimate",
                     values = c("Expected # of Popped Kernels" = "red")) +
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid = element_blank(), axis.line = element_line(colour = "black"))



